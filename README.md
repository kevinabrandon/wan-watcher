# wan-watcher

A physical WAN health indicator for pfSense using an ESP32.

wan-watcher collects real-time WAN metrics from pfSense (latency, loss, jitter, and bandwidth usage) and exposes them to an ESP32, which drives LEDs and (eventually) a 7-segment display. The result is a small physical panel that shows your internet health at a glance.

---

## Features (current & planned)

* **pfSense metrics collector**

  * Polls dpinger sockets for latency / jitter / loss
  * Auto-maps each dpinger instance to its WAN interface
  * Calculates per-WAN bandwidth usage (Mbps)
  * Writes clean status/metrics files in `/var/run` for consumers

* **Multi-WAN aware**

  * Supports multiple dpinger instances (e.g., WAN + WAN2)
  * Tracks per-WAN state and usage separately

* **ESP32 indicator panel** (planned / in progress)

  * Consumes WAN status and metrics from pfSense
  * LED indicators for WAN state (up / degraded / down / unknown)
  * Heartbeat indication when pfSense stops reporting
  * 7-segment display support for latency / bandwidth (phase 2)

## Hardware (planned build)

* 1× Olimex ESP32-POE-ISO
* 1× power switch
* 12× panel-mount 5V LEDs
* 1× push switch (phase 2)
* 2× 7-segment displays (phase 2)

## Repository Structure

```
wan-watcher/
  pf/            # pfSense scripts (cron polling, dpinger, usage)
  esp32/         # ESP32 firmware (LEDs, 7-seg, API endpoints)
  hardware/      # wiring diagrams, panel layout, BOM
  docs/          # architecture notes, API descriptions
  README.md
  .gitignore
```

## ESP32 Wi-Fi Configuration

Inside `esp32/src/`, you will find:

## ESP32 Wi-Fi Configuration

Inside `esp32/src/`, you will find:

```
wifi_config.h.example
```

Copy it to `wifi_config.h` and edit your SSID/password:

```sh
cp esp32/src/wifi_config.h.example esp32/src/wifi_config.h
```

`wifi_config.h` is intentionally **ignored by git** and should never be committed.

Each ESP32 assigns itself a unique hostname based on its MAC address:

```
wan-watcher-xxxxxx
```

The device also exposes itself via mDNS (Bonjour/Avahi):

```
http://wan-watcher-xxxxxx.local/
```

Your operating system must support mDNS for this to work (macOS: built-in, Linux: Avahi, Windows: Bonjour).

---

## Installation (pfSense script)

1. Copy `pf/wan_watcher_poll.sh` to:

   ```sh
   /usr/local/bin/wan_watcher_poll.sh
   ```

2. Make it executable:

   ```sh
   chmod +x /usr/local/bin/wan_watcher_poll.sh
   ```

3. Add two cron jobs (via pfSense Cron package):

   ```
   * * * * * /usr/local/bin/wan_watcher_poll.sh 0
   * * * * * /usr/local/bin/wan_watcher_poll.sh 30
   ```

The script updates WAN status and usage files every ~30 seconds.

---

## Status Files (generated by pfSense)

```
/var/run/wan_watcher_wan1.status    # "<state> <timestamp>"
/var/run/wan_watcher_wan1.metrics   # "<lat_ms> <std_ms> <loss> <timestamp>"
/var/run/wan_watcher_wan1.usage     # "<down_mbps> <up_mbps> <timestamp>"
```

---

## Roadmap

### pfSense Side

* [x] Poll dpinger for latency/jitter/loss
* [x] Auto-detect WAN interfaces
* [x] Calculate per-WAN bandwidth usage
* [ ] Implement HTTP client to POST metrics to ESP32 (REST-ish API)
* [ ] Multi-WAN POST support
* [ ] Heartbeat POSTs

### ESP32 Side

* [x] Basic PlatformIO firmware project scaffolding
* [x] Wi-Fi connect loop with status LED
* [x] Dynamic hostname + mDNS support
* [x] HTTP server + routes
* [x] WAN1 LED state machine (UP / DEGRADED / DOWN)
* [x] Web UI with simple color indicators
* [ ] REST-ish HTTP API endpoint to receive metrics from pfSense
* [ ] pfSense heartbeat timeout LED
* [ ] Multi-WAN support
* [ ] 7-segment display driver (phase 2)
* [ ] Display modes (latency / download / upload / loss) (phase 2)
* [ ] Button input for cycling modes (phase 2)

### Hardware

* [ ] Layout for LED + 7-segment panel
* [ ] Wiring diagram
* [ ] Parts list (LEDs, resistors, ESP32 dev board)
* [ ] Optional 3D-printed enclosure

### Documentation

* [ ] API description for pfSense → ESP32
* [ ] Developer notes
* [ ] Final photos / example builds

---

## License

MIT

## Contributions

This is a hobby/utility project. Suggestions welcome as it evolves.
